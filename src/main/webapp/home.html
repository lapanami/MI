<#include "/common/header.html">
    <style type="text/css" rel="stylesheet">
        .modal-body ul li label
        {
            width: 90px;
        }
        .modal-body ul {
            list-style-type: none;
        }
        .modal-body li {
            margin-bottom: 5px;
        }
    </style>
    <script src="${contextPath}/static/js/jquery.dataTables.min.js"></script>
    <script src="${contextPath}/static/js/dataTables.bootstrap.min.js"></script>
    <table style="width: 100%" cellpadding="0" cellspacing="0" class="dev_page_border">
        <tr>
            <td style="width: 10px">
            </td>
            <td style="width: 99%">
            <table cellpadding="2" cellspacing="2" class="dev_company_title">
                <tr>        
                    <td style="width: 100px" valign="bottom">
                        <a href="${contextPath}/">
                            <img src="${contextPath}/images/logo-home-credit-group.gif" alt="" /></a>
                    </td>
                    <td class="dev_top_center">
                        Home Credit Vietnam
                        <div class="dev_comany_version">
                            Version 1.0</div>
                    </td>
                    <td style="width: 300px">
                        <div class="dev_top_right_area">
                                <table cellpadding="0" cellspacing="0">
                                    <tr>
                                        <td>
                                            <a class="dev_color_link" href="/Help">Help</a>
                                        </td>
                                        <td>
                                            <a class="dev_color_link" href="/Help">
                                                <img src="${contextPath}/images/help_20.png" alt="Help" />
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                                <p>
                                                    HELLO ${user.username?upper_case}
            [<a href="${contextPath}/logout">Log Out</a>]                                    </p>
                                        </td>
                                        <td>
                                            <img src="${contextPath}/images/user.png" alt="User Profile" />
                                        </td>
                                    </tr>
                                </table>
                        </div>
                    </td>        
                </tr>
            </table>
            <div id="header-separator">
            </div>
            <div class="clr">
            </div>
            <#include "/common/menu.html">
            <div class="dev_breadcrumb">
                <div class="dev_breadcrumb_left">
                    <a href="${contextPath}/">Home</a></div>
                <div class="dev_breadcrumb_right">
                    
                <a href="${contextPath}/">Home</a>
                </div>
            </div>
            <div id="div_notify" style="display: none;">
                <div class="clr">
                </div>
                <div id="div_css_notify">
                    <table style="width: 100%">
                        <tr>
                            <td style="width: 1%">
                                <img id="img_notify" alt="" />
                            </td>
                            <td id="div_notify_message">
                            </td>
                            <td style="width: 1%" valign="top">
                                <a onclick="closeClientMessage()">
                                    <img src="${contextPath}/images/cancel_16.png" /></a>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <script type="text/javascript">
                function closeClientMessage() {
                    $("#div_notify").fadeOut("slow")
                }
            </script>
                <div class="dev_body_content">
                    List user from Oracle
                    <table width="100%" class="display" id="userList" cellspacing="0">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>User Name</th>
                                <th>Email</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <#list listUser as user>
                            <tr data-uid="${user.userId}">
                                <td>${user.firstName}</td>
                                <td>${user.lastName}</td>
                                <td>${user.userName}</td>
                                <td>${user.email}</td>
                                <td>${user.createdBy}</td>
                                <td><#if user.createdDate??> ${user.createdDate?string["dd.MM.yyyy"]} </#if></td>
                            </tr>
                        </#list>
                        </tbody>
                    </table>
                    List user from MS SQL
                    <table width="100%" class="display" id="userList1" cellspacing="0">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>User Name</th>
                                <th>HR Title</th>
                                <th>Email</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                            </tr>
                        </thead>
                    </table>
                    <div id="myModal" class="modal fade" role="dialog">
                      <div class="modal-dialog">

                        <!-- Modal content-->
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">User Information</h4>
                          </div>
                          <div class="modal-body">
                            <form action="${contextPath}/user/put" id="userPutForm">
                                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                                <input type="hidden" name="userId" id="userId">
                                <ul>
                                    <li><label>Username:</label><b class="form-control" id="userName"></b></li>
                                    <li><label>First Name:</label><input type="text" name="firstName" placeholder="First Name" class="form-control" id="firstName"></li>
                                    <li><label>Last Name:</label><input type="text" name="lastName" placeholder="Last Name" class="form-control" id="lastName"></li>
                                    <li><label>Email:</label><b class="form-control" id="email"></b></li>
                                    <li><label>Status:</label><b class="form-control" id="status"></b></li>
                                </ul>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-success" id="btnSave">Save</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                          </div>
                        </div>

                      </div>
                    </div>
                </div>
                <div id="dev_footer">
                    <div id="dev_terms">
                        Designed by Home Credit Vietnam Internal Development Team.
                    </div>
                    Copyright 2012 &copy; Home Credit Vietnam. All
                    rights reserved.
                </div>
                <div id="div_loading" style="display: none;">
                    <img src="${contextPath}/images/ajax-loader-2.gif" />
                </div>
                <div id="div_overlay">
                </div>            
            </td>
            <td style="width: 10px">
            </td>
        </tr>
    </table>
<div class="alert alert-success alert-dismissible" id="alert">
    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <strong>Success!</strong> <i>This alert box could indicate a successful or positive action.</i>
</div>
<script type="text/javascript">
    var contextPath = <#if contextPath??>'${contextPath}'<#else>''</#if> + "/";
    var userList = $("#userList").DataTable({
        "language": {
            "info": "Showing _START_ to _END_ of _TOTAL_ users"
        },
        "fnDrawCallback": function( oSettings ) {
            $('#userList tbody tr').css("cursor", "pointer");
        }
    });
    var userList1 = $("#userList1").DataTable({
        "language": {
            "info": "Showing _START_ to _END_ of _TOTAL_ users"
        },
        "fnDrawCallback": function( oSettings ) {
            $('#userList1 tbody tr').css("cursor", "pointer");
        },
        "sServerMethod": "POST",
        "processing": true,
        "serverSide": true,
        'ajax': {
            'contentType': 'application/json',
            'url': contextPath + "userlist",
            'type': 'POST',
            'data': function(d) {
                return JSON.stringify(d);
            }
        },
        "columns": [
            { "data": "firstName", "name": "firstName", "title": "First Name" },
            { "data": "lastName", "name": "lastName", "title": "Last Name" },
            { "data": "userName", "name": "userName", "title": "User Name" },
            { "data": "hrTitle", "name": "hrTitle", "title": "HR Title" },
            { "data": "email", "name": "email", "title": "Email" },
            { "data": "createdBy", "name": "createdBy", "title": "Created By" },
            { "data": "createdDate", "name": "createdDate", "title": "Created Date",
                "render": function ( data, type, row ) {
                    return (new Date(data)).toLocaleDateString("vi-vn");
                } }
        ],
        fnServerParams: function(data) {
            data['order'].forEach(function(items, index) {
                data['order'][index]['column'] = data['columns'][items.column]['data'];
            });
        },
    });
    var jsonListUser = <#if jsonListUser??>${jsonListUser}<#else >''</#if>;
    var jsonListMSUser = <#if jsonListMSUser??>${jsonListMSUser}<#else >''</#if>;
    var mapUser = {}, mapMSUser = {};
    for (var i = 0; i < jsonListUser.length; i++) {
        mapUser[jsonListUser[i].userId] = jsonListUser[i];
    }
    for (var i = 0; i < jsonListMSUser.length; i++) {
        mapMSUser[jsonListMSUser[i].userId] = jsonListMSUser[i];
    }
    function setUserInfo(user) {
        $("#userName").html(user.userName);
        $("#firstName").val(user.firstName);
        $("#lastName").val(user.lastName);
        $("#email").html(user.email);
        if (user.status) {
            $("#status").html("Active");
        } else {
            $("#status").html("Inactive");
        }
        $("#userId").val(user.userId);
    }
    function userInfo(userId) {
        var user;
        if (!userId.userId) {
            user = mapUser[userId];
            $("#btnSave").prop('disabled', true);
        } else {
            user = userId;
            $("#btnSave").prop('disabled', false);
        }
        setUserInfo(user? user : mapMSUser[userId]);
        $("#myModal").modal("toggle");
    }
    function validateUserForm() {
        if (!$("#userId").val()) {
            return "Wrong input parameter, cannot find user identity in request, please request the page!";
        }
        if (!$("#firstName").val()) {
            return "Wrong input parameter, First Name cannot be empty!";
        }
        if (!$("#lastName").val()) {
            return "Wrong input parameter, Last Name cannot be empty!";
        }
    }
    $('#userList tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            $(this).parent().find('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
        userInfo($(this).attr("data-uid"));
    } );
    $('#userList1 tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
            $(this).parent().find('tr.selected').removeClass('selected');
            $(this).addClass('selected');
        }
        userInfo(userList1.row(this).data());
    } );
    $("#alert").hide();
    $('#myModal').on('hidden.bs.modal', function () {
        setTimeout(function() {
            userList1.ajax.reload(null, false);
        }, 200);
    })
    $( "#btnSave" ).click(function() {
        var errMessage = validateUserForm();
        if (!errMessage) {
            $("#userPutForm").ajaxSubmit({
                url: contextPath + 'user/put', 
                type: 'post',
                error: function(result) {
                    $("#alert").removeClass("alert-success").addClass("alert-danger");
                    $("#alert strong").html("Error!");
                    $("#alert i").html("Cannot connect to server!");
                    $("#alert").show();
                    setTimeout(function() {
                        $("#alert").hide();
                    }, 5000);
                },
                success: function(result) {
                    if (result.error == 0) {
                        $("#alert").removeClass("danger-danger").addClass("alert-success");
                        $("#alert strong").html("Success!");
                        $("#alert i").html(result.message);
                        $("#alert").show();
                        setTimeout(function() {
                            $("#alert").hide();
                        }, 5000);
                    } else {
                        $("#alert").removeClass("alert-success").addClass("alert-danger");
                        $("#alert strong").html("Error!");
                        $("#alert i").html(result.message);
                        $("#alert").show();
                        setTimeout(function() {
                            $("#alert").hide();
                        }, 5000);
                    }
                }
            });
        } else {
            $("#alert").removeClass("alert-success").addClass("alert-danger");
            $("#alert strong").html("Error!");
            $("#alert i").html(errMessage);
            $("#alert").show();
            setTimeout(function() {
                $("#alert").hide();
            }, 5000);
        }
    });
</script>
<#include "/common/footer.html">
